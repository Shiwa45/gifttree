{% extends 'base.html' %}
{% load static %}

{% block title %}{{ product.name }} - Buy Online | GiftTree{% endblock %}

{% block content %}
<style>
/* Modern Product Detail Page Styles */
:root {
    --primary: #E91E63;
    --secondary: #4CAF50;
    --text-dark: #212121;
    --text-light: #757575;
    --border: #E0E0E0;
    --bg-light: #F5F5F5;
}

.product-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

/* Mobile Header */
.mobile-header {
    display: none;
    padding: 12px 16px;
    background: white;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    position: sticky;
    top: 0;
    z-index: 100;
}

.mobile-header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.back-btn {
    background: none;
    border: none;
    font-size: 20px;
}

.header-actions {
    display: flex;
    gap: 16px;
}

.header-btn {
    background: none;
    border: none;
    font-size: 20px;
    position: relative;
}

/* Product Layout */
.product-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px;
    margin-top: 20px;
}

/* Gallery Section */
.gallery-section {
    position: relative;
}

.main-image {
    width: 100%;
    max-height: 500px;
    object-fit: contain;
    background: white;
    border-radius: 12px;
    padding: 20px;
    border: 1px solid var(--border);
}

.image-badges {
    position: absolute;
    top: 16px;
    left: 16px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.badge {
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    color: white;
    background: var(--primary);
}

.badge.discount {
    background: #FF9800;
}

.thumbnail-row {
    display: flex;
    gap: 12px;
    margin-top: 16px;
    overflow-x: auto;
}

.thumbnail {
    width: 80px;
    height: 80px;
    border: 2px solid transparent;
    border-radius: 8px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s;
}

.thumbnail.active {
    border-color: var(--primary);
}

.thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

/* Info Section */
.info-section {
    padding: 0 20px;
}

.product-title {
    font-size: 28px;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--text-dark);
}

.rating-row {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 20px;
}

.stars {
    color: #FFC107;
}

.rating-text {
    color: var(--text-light);
    font-size: 14px;
}

.price-box {
    background: var(--bg-light);
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 24px;
}

.price-row {
    display: flex;
    align-items: baseline;
    gap: 12px;
    margin-bottom: 8px;
}

.current-price {
    font-size: 32px;
    font-weight: 700;
    color: var(--text-dark);
}

.original-price {
    font-size: 20px;
    color: var(--text-light);
    text-decoration: line-through;
}

.discount-badge {
    background: var(--secondary);
    color: white;
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 14px;
}

.tax-note {
    font-size: 13px;
    color: var(--text-light);
}

/* Variants */
.variant-section {
    margin-bottom: 24px;
}

.section-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 12px;
}

.variant-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
}

.variant-btn {
    padding: 12px;
    border: 2px solid var(--border);
    border-radius: 8px;
    background: white;
    cursor: pointer;
    transition: all 0.3s;
    text-align: center;
}

.variant-btn.active {
    border-color: var(--primary);
    background: rgba(233, 30, 99, 0.05);
}

.variant-name {
    font-weight: 600;
    display: block;
}

.variant-price {
    font-size: 13px;
    color: var(--text-light);
}

/* Delivery Section */
.delivery-section {
    background: #FFF8F0;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 24px;
}

.pincode-check {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
}

.pincode-input {
    flex: 1;
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 8px;
}

.check-btn {
    padding: 10px 20px;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
}

.delivery-slots {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin-top: 16px;
}

.slot-card {
    padding: 12px;
    border: 2px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
}

.slot-card.active {
    border-color: var(--primary);
    background: rgba(233, 30, 99, 0.05);
}

.slot-icon {
    font-size: 20px;
    color: var(--primary);
    margin-bottom: 4px;
}

.slot-name {
    font-weight: 600;
    font-size: 14px;
}

.slot-time {
    font-size: 12px;
    color: var(--text-light);
}

/* Add-ons */
.addons-section {
    margin-bottom: 24px;
}

.addon-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 16px;
}

.addon-card {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px;
    border: 2px solid var(--border);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
}

.addon-card.selected {
    border-color: var(--primary);
    background: rgba(233, 30, 99, 0.05);
}

.addon-card.selected::after {
    content: '‚úì';
    position: absolute;
    top: 8px;
    right: 8px;
    width: 20px;
    height: 20px;
    background: var(--primary);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
}

.addon-img {
    width: 60px;
    height: 60px;
    border-radius: 8px;
    object-fit: cover;
}

.addon-info {
    flex: 1;
}

.addon-name {
    font-weight: 600;
    font-size: 14px;
}

.addon-desc {
    font-size: 12px;
    color: var(--text-light);
}

.addon-price {
    font-weight: 600;
    color: var(--primary);
}

/* Action Buttons */
.action-row {
    display: flex;
    gap: 12px;
    margin-bottom: 24px;
}

.qty-selector {
    display: flex;
    align-items: center;
    border: 2px solid var(--border);
    border-radius: 8px;
}

.qty-btn {
    width: 40px;
    height: 40px;
    border: none;
    background: none;
    font-size: 18px;
    cursor: pointer;
}

.qty-input {
    width: 60px;
    text-align: center;
    border: none;
    font-size: 16px;
    font-weight: 600;
}

.btn-cart, .btn-buy {
    flex: 1;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
}

.btn-cart {
    background: white;
    color: var(--primary);
    border: 2px solid var(--primary);
}

.btn-buy {
    background: var(--primary);
    color: white;
}

.btn-cart:disabled, .btn-buy:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* USP Icons */
.usp-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    padding: 20px;
    background: var(--bg-light);
    border-radius: 12px;
    margin-bottom: 24px;
}

.usp-item {
    text-align: center;
}

.usp-icon {
    font-size: 24px;
    color: var(--primary);
    margin-bottom: 8px;
}

.usp-text {
    font-size: 12px;
    color: var(--text-dark);
}

/* Tabs */
.tabs-section {
    margin-top: 40px;
}

.tab-headers {
    display: flex;
    border-bottom: 2px solid var(--border);
    gap: 24px;
    overflow-x: auto;
}

.tab-btn {
    padding: 12px 0;
    background: none;
    border: none;
    font-weight: 600;
    color: var(--text-light);
    cursor: pointer;
    position: relative;
}

.tab-btn.active {
    color: var(--primary);
}

.tab-btn.active::after {
    content: '';
    position: absolute;
    bottom: -2px;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--primary);
}

.tab-content {
    display: none;
    padding: 24px 0;
}

.tab-content.active {
    display: block;
}

/* Related Products */
.related-section {
    margin-top: 60px;
    padding: 40px 0;
    background: var(--bg-light);
}

.related-title {
    text-align: center;
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 30px;
}

.related-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 20px;
}

.related-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    transition: transform 0.3s;
    cursor: pointer;
}

.related-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}

.related-img {
    width: 100%;
    height: 200px;
    object-fit: cover;
}

.related-info {
    padding: 12px;
}

.related-name {
    font-weight: 600;
    margin-bottom: 8px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.related-price {
    color: var(--primary);
    font-size: 18px;
    font-weight: 700;
}

/* Mobile Sticky Footer */
.mobile-footer {
    display: none;
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    padding: 12px 16px;
    box-shadow: 0 -4px 12px rgba(0,0,0,0.1);
    z-index: 100;
}

/* Show mobile footer only on mobile devices */
@media screen and (max-width: 768px) {
    .mobile-footer {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
        z-index: 9999 !important;
        background: white !important;
        border-top: 2px solid #e91e63 !important;
    }
}

.mobile-price {
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 8px;
    color: #333 !important;
    text-align: center !important;
}

.mobile-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .mobile-header {
        display: block;
    }
    
    .product-container {
        padding: 0;
        max-width: 100%;
        overflow-x: hidden;
    }
    
    .product-grid {
        grid-template-columns: 1fr;
        gap: 0;
    }
    
    .gallery-section {
        padding: 16px;
    }
    
    .main-image {
        border-radius: 0;
        border: none;
        padding: 0;
        max-width: 100%;
        height: auto;
        max-height: 400px;
    }
    
    .info-section {
        padding: 16px;
        max-width: 100%;
        overflow-x: hidden;
    }
    
    .product-title {
        font-size: 18px;
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
    }
    
    .current-price {
        font-size: 24px;
    }
    
    .original-price {
        font-size: 16px;
    }
    
    .price-box {
        padding: 16px;
    }
    
    .variant-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }
    
    .variant-btn {
        padding: 10px 8px;
        font-size: 14px;
    }
    
    .variant-name {
        font-size: 13px;
    }
    
    .variant-price {
        font-size: 12px;
    }
    
    .delivery-section {
        padding: 16px;
    }
    
    .delivery-slots {
        grid-template-columns: 1fr;
        gap: 8px;
    }
    
    .slot-card {
        padding: 10px;
    }
    
    .addon-grid {
        grid-template-columns: 1fr;
        gap: 12px;
    }
    
    .addon-card {
        padding: 10px;
    }
    
    .addon-img {
        width: 50px;
        height: 50px;
    }
    
    .addon-name {
        font-size: 13px;
    }
    
    .addon-desc {
        font-size: 11px;
    }
    
    .addon-price {
        font-size: 13px;
    }
    
    .usp-row {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        padding: 16px;
    }
    
    .usp-icon {
        font-size: 20px;
    }
    
    .usp-text {
        font-size: 11px;
    }
    
    .tabs-section {
        padding: 0 16px;
    }
    
    .tab-headers {
        gap: 16px;
        padding-bottom: 2px;
    }
    
    .tab-btn {
        font-size: 14px;
        padding: 10px 0;
        white-space: nowrap;
    }
    
    .tab-content {
        padding: 16px 0;
        font-size: 14px;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .tab-content h3 {
        font-size: 18px;
        margin-bottom: 12px;
    }
    
    .tab-content h4 {
        font-size: 16px;
        margin-top: 16px;
        margin-bottom: 10px;
    }
    
    .tab-content p {
        font-size: 14px;
        line-height: 1.6;
    }
    
    .tab-content table {
        font-size: 14px;
        display: block;
        overflow-x: auto;
        white-space: nowrap;
    }
    
    .tab-content td {
        padding: 8px 0 !important;
    }
    
    .related-section {
        padding: 24px 16px;
        margin-top: 40px;
    }
    
    .related-title {
        font-size: 20px;
        margin-bottom: 20px;
    }
    
    .related-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
    }
    
    .related-card {
        border-radius: 8px;
    }
    
    .related-img {
        height: 140px;
    }
    
    .related-info {
        padding: 10px;
    }
    
    .related-name {
        font-size: 13px;
        margin-bottom: 6px;
    }
    
    .related-price {
        font-size: 16px;
    }
    
    /* Mobile footer is now handled by more specific CSS above */
    
    .action-row {
        display: none;
    }
    
    .mobile-price {
        font-size: 18px;
    }
    
    .mobile-buttons {
        gap: 8px;
    }
    
.mobile-buttons .btn-cart,
.mobile-buttons .btn-buy {
    padding: 10px 16px;
    font-size: 14px;
    border-radius: 8px;
    background: #e91e63 !important;
    color: white !important;
    border: none !important;
    cursor: pointer !important;
    width: 100% !important;
    display: block !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    letter-spacing: 0.5px !important;
}

.mobile-buttons .btn-buy {
    background: #ff5722 !important;
}

.mobile-buttons {
    display: grid !important;
    grid-template-columns: 1fr 1fr !important;
    gap: 8px !important;
    margin-top: 8px !important;
}
    
    body {
        padding-bottom: 120px;
        overflow-x: hidden;
    }
    
    /* Ensure all images are responsive */
    img {
        max-width: 100%;
        height: auto;
    }
    
    /* Fix any potential overflow issues */
    * {
        max-width: 100%;
    }
    
    /* Specific fixes for content sections */
    .section-title {
        font-size: 15px;
        margin-bottom: 10px;
    }
    
    .pincode-input {
        font-size: 14px;
        padding: 8px;
    }
    
    .check-btn {
        padding: 8px 16px;
        font-size: 14px;
    }
    
    .thumbnail-row {
        gap: 8px;
        margin-top: 12px;
    }
    
    .thumbnail {
        width: 60px;
        height: 60px;
    }
    
    .rating-row {
        margin-bottom: 16px;
        flex-wrap: wrap;
    }
    
    .rating-text {
        font-size: 13px;
    }
}

/* Extra small devices */
@media (max-width: 480px) {
    .product-title {
        font-size: 16px;
    }
    
    .current-price {
        font-size: 22px;
    }
    
    .variant-grid {
        grid-template-columns: 1fr;
    }
    
    .usp-row {
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
    }
    
    .related-grid {
        grid-template-columns: 1fr;
    }
    
    .mobile-slider {
        height: 200px;
    }
}
</style>

<!-- Mobile Header -->
<div class="mobile-header">
    <div class="mobile-header-content">
        <button class="back-btn" onclick="history.back()">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div class="header-actions">
            <button class="header-btn" onclick="shareProduct()">
                <i class="fas fa-share-alt"></i>
            </button>
            <button class="header-btn" onclick="toggleWishlist()">
                <i class="far fa-heart" id="wishlistIcon"></i>
            </button>
            <a href="{% url 'cart:cart' %}" class="header-btn">
                <i class="fas fa-shopping-cart"></i>
                <span class="cart-badge">{{ cart_count|default:0 }}</span>
            </a>
        </div>
    </div>
</div>

<div class="product-container">
    <!-- CSRF Token for AJAX -->
    {% csrf_token %}
    
    <div class="product-grid">
        <!-- Gallery -->
        <div class="gallery-section">
            <div style="position: relative;">
                {% if product.primary_image and product.primary_image.get_image_url %}
                    <img src="{{ product.primary_image.get_image_url }}" alt="{{ product.name }}" class="main-image" id="mainImage">
                {% elif product.all_images and product.all_images.0.get_image_url %}
                    <img src="{{ product.all_images.0.get_image_url }}" alt="{{ product.name }}" class="main-image" id="mainImage">
                {% else %}
                    <img src="{% static 'images/products/rose.webp' %}" alt="{{ product.name }}" class="main-image" id="mainImage">
                {% endif %}
                
                <div class="image-badges">
                    {% if product.is_bestseller %}
                        <span class="badge">Bestseller</span>
                    {% endif %}
                    {% if product.discount_percentage %}
                        <span class="badge discount">{{ product.discount_percentage }}% OFF</span>
                    {% endif %}
                </div>
            </div>
            
            <div class="thumbnail-row">
                {% for image in product.all_images %}
                    <div class="thumbnail {% if forloop.first %}active{% endif %}" 
                         onclick="changeImage('{{ image.get_image_url|escapejs }}', this)">
                        <img src="{{ image.get_image_url }}" alt="{{ product.name }}" data-fallback="{% static 'images/products/default.jpg' %}" onerror="this.src=this.dataset.fallback">
                    </div>
                {% empty %}
                    {% if product.primary_image and product.primary_image.get_image_url %}
                        <div class="thumbnail active">
                            <img src="{{ product.primary_image.get_image_url }}" alt="{{ product.name }}" data-fallback="{% static 'images/products/default.jpg' %}" onerror="this.src=this.dataset.fallback">
                        </div>
                    {% else %}
                        <div class="thumbnail active">
                            <img src="{% static 'images/products/rose.webp' %}" alt="{{ product.name }}">
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Info -->
        <div class="info-section">
            <h1 class="product-title">{{ product.name }}</h1>
            
            <div class="rating-row">
                <div class="stars">
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star"></i>
                    <i class="fas fa-star-half-alt"></i>
                </div>
                <span class="rating-text">4.5 (234 Reviews)</span>
            </div>

            <div class="price-box">
                <div class="price-row">
                    <span class="current-price">‚Çπ<span id="price">{{ product.current_price|floatformat:0 }}</span></span>
                    {% if product.discount_price %}
                        <span class="original-price">‚Çπ{{ product.base_price|floatformat:0 }}</span>
                        <span class="discount-badge">Save ‚Çπ{{ product.base_price|add:"-"|add:product.current_price|floatformat:0 }}</span>
                    {% endif %}
                </div>
                <p class="tax-note">Inclusive of all taxes</p>
            </div>

            {% if product.variants.all %}
            <div class="variant-section">
                <h3 class="section-title">Choose Size:</h3>
                <div class="variant-grid">
                    {% for variant in product.variants.all %}
                        <button class="variant-btn {% if forloop.first %}active{% endif %}" 
                                data-variant-id="{{ variant.id }}"
                                onclick="selectVariant(this, {{ variant.final_price }})">
                            <span class="variant-name">{{ variant.name }}</span>
                            <span class="variant-price">‚Çπ{{ variant.final_price|floatformat:0 }}</span>
                        </button>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="delivery-section">
                <h3 class="section-title">Delivery Options:</h3>
                <div class="pincode-check">
                    <input type="text" class="pincode-input" placeholder="Enter Pincode" id="pincode" maxlength="6">
                    <button class="check-btn" onclick="checkPincode()">Check</button>
                </div>
                <div id="pincode-message"></div>
                
                <div class="delivery-slots">
                    <div class="slot-card active" onclick="selectSlot(this, 0)">
                        <div class="slot-icon">üöö</div>
                        <div class="slot-name">Same Day</div>
                        <div class="slot-time">Before 10 PM</div>
                    </div>
                    <div class="slot-card" onclick="selectSlot(this, 99)">
                        <div class="slot-icon">‚è∞</div>
                        <div class="slot-name">Fixed Time</div>
                        <div class="slot-time">+‚Çπ99</div>
                    </div>
                    <div class="slot-card" onclick="selectSlot(this, 149)">
                        <div class="slot-icon">üåô</div>
                        <div class="slot-name">Midnight</div>
                        <div class="slot-time">+‚Çπ149</div>
                    </div>
                    <div class="slot-card" onclick="selectSlot(this, 0)">
                        <div class="slot-icon">üìÖ</div>
                        <div class="slot-name">Standard</div>
                        <div class="slot-time">2-3 Days</div>
                    </div>
                </div>
            </div>

            {% if available_addons %}
            <div class="addons-section">
                <h3 class="section-title">Make it Extra Special:</h3>
                <div class="addon-grid">
                    {% for addon in available_addons %}
                    <div class="addon-card" 
                         data-addon-id="{{ addon.id }}"
                         data-addon-name="{{ addon.name }}" 
                         data-addon-price="{{ addon.price }}"
                         onclick="toggleAddon(this)">
                        {% if addon.image %}
                            <img src="{{ addon.image.url }}" alt="{{ addon.name }}" class="addon-img"
                                 onerror="this.src='{% static 'images/products/default.jpg' %}'">
                        {% else %}
                            <img src="{% static 'images/products/default.jpg' %}" alt="{{ addon.name }}" class="addon-img">
                        {% endif %}
                        <div class="addon-info">
                            <div class="addon-name">{{ addon.name }}</div>
                            <div class="addon-desc">{{ addon.description|truncatewords:5 }}</div>
                        </div>
                        <div class="addon-price">+‚Çπ{{ addon.price|floatformat:0 }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <div class="action-row">
                <div class="qty-selector">
                    <button type="button" class="qty-btn" onclick="updateQty(-1)">-</button>
                    <input type="number" class="qty-input" id="qty" name="quantity" value="1" min="1" max="10" readonly>
                    <button type="button" class="qty-btn" onclick="updateQty(1)">+</button>
                </div>

                <!-- Add to Cart Form -->
                <form method="POST" action="{% url 'cart:add_to_cart' %}" class="d-inline-block" id="addToCartForm">
                    {% csrf_token %}
                    <input type="hidden" name="product_id" value="{{ product.id }}">
                    <input type="hidden" name="variant_id" id="formVariantId" value="">
                    <input type="hidden" name="quantity" id="formQuantity" value="1">
                    <button type="submit" class="btn-cart" id="addCartBtn" onclick="updateFormDataBeforeSubmit(event, 'addToCartForm')">
                        <i class="fas fa-shopping-cart"></i> Add to Cart
                    </button>
                </form>

                <!-- Buy Now: submit same form but redirect handled server-side or via a query param -->
                <form method="POST" action="{% url 'cart:add_to_cart' %}" class="d-inline-block" id="buyNowForm">
                    {% csrf_token %}
                    <input type="hidden" name="product_id" value="{{ product.id }}">
                    <input type="hidden" name="variant_id" id="buyVariantId" value="">
                    <input type="hidden" name="quantity" id="buyQuantity" value="1">
                    <input type="hidden" name="buy_now" value="1">
                    <button type="submit" class="btn-buy" id="buyNowBtn" onclick="updateFormDataBeforeSubmit(event, 'buyNowForm')">
                        <i class="fas fa-bolt"></i> Buy Now
                    </button>
                </form>
            </div>

            <div class="usp-row">
                <div class="usp-item">
                    <div class="usp-icon">üöö</div>
                    <div class="usp-text">Free Delivery</div>
                </div>
                <div class="usp-item">
                    <div class="usp-icon">üõ°Ô∏è</div>
                    <div class="usp-text">Safe Payment</div>
                </div>
                <div class="usp-item">
                    <div class="usp-icon">üèÜ</div>
                    <div class="usp-text">Best Quality</div>
                </div>
                <div class="usp-item">
                    <div class="usp-icon">‚Ü©Ô∏è</div>
                    <div class="usp-text">Easy Returns</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="tabs-section">
        <div class="tab-headers">
            <button class="tab-btn active" onclick="switchTab(this, 'description')">Description</button>
            <button class="tab-btn" onclick="switchTab(this, 'details')">Details</button>
            <button class="tab-btn" onclick="switchTab(this, 'delivery')">Delivery</button>
            <button class="tab-btn" onclick="switchTab(this, 'reviews')">Reviews</button>
        </div>
        
        <div class="tab-content active" id="tab-description">
            <h3>About This Product</h3>
            <p>{{ product.description|linebreaks }}</p>
            {% if product.care_instructions %}
                <h4>Care Instructions</h4>
                <p>{{ product.care_instructions|linebreaks }}</p>
            {% endif %}
        </div>
        
        <div class="tab-content" id="tab-details">
            <h3>Product Details</h3>
            <table style="width:100%; border-collapse:collapse;">
                <tr style="border-bottom:1px solid #E0E0E0; padding:10px 0;">
                    <td style="padding:10px 0;">SKU</td>
                    <td>{{ product.sku }}</td>
                </tr>
                <tr style="border-bottom:1px solid #E0E0E0; padding:10px 0;">
                    <td style="padding:10px 0;">Category</td>
                    <td>{{ product.category.name }}</td>
                </tr>
                <tr style="border-bottom:1px solid #E0E0E0; padding:10px 0;">
                    <td style="padding:10px 0;">Stock</td>
                    <td>{% if product.is_in_stock %}In Stock{% else %}Out of Stock{% endif %}</td>
                </tr>
            </table>
        </div>
        
        <div class="tab-content" id="tab-delivery">
            <h3>Delivery Information</h3>
            <ul>
                <li>Same Day Delivery available for orders before 5 PM</li>
                <li>Midnight delivery available with extra charges</li>
                <li>Free delivery on orders above ‚Çπ999</li>
                <li>We deliver to 500+ cities across India</li>
            </ul>
        </div>
        
        <div class="tab-content" id="tab-reviews">
            <h3>Customer Reviews</h3>
            <p>No reviews yet. Be the first to review!</p>
        </div>
    </div>

    <!-- Related Products Section -->
    {% if related_products %}
    <div class="related-section">
        <h2 class="related-title">You May Also Like</h2>
        <div class="related-grid">
            {% for related in related_products %}
            <div class="related-card" onclick="window.location.href='{{ related.get_absolute_url }}'">
                {% if related.primary_image and related.primary_image.get_image_url %}
                    <img src="{{ related.primary_image.get_image_url }}" alt="{{ related.name }}" class="related-img" data-fallback="{% static 'images/products/default.jpg' %}" onerror="this.src=this.dataset.fallback">
                {% elif related.all_images and related.all_images.0.get_image_url %}
                    <img src="{{ related.all_images.0.get_image_url }}" alt="{{ related.name }}" class="related-img" data-fallback="{% static 'images/products/default.jpg' %}" onerror="this.src=this.dataset.fallback">
                {% else %}
                    <img src="{% static 'images/products/default.jpg' %}" alt="{{ related.name }}" class="related-img">
                {% endif %}
                <div class="related-info">
                    <div class="related-name">{{ related.name|truncatechars:30 }}</div>
                    <div class="related-price">‚Çπ{{ related.current_price|floatformat:0 }}</div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Mobile Footer -->
<div class="mobile-footer">
    <div class="mobile-price">Total: ‚Çπ<span id="mobilePrice">{{ product.current_price|floatformat:0 }}</span></div>
    <div class="mobile-buttons">
        <form method="POST" action="{% url 'cart:add_to_cart' %}" id="mobileAddForm" class="d-inline-block">
            {% csrf_token %}
            <input type="hidden" name="product_id" value="{{ product.id }}">
            <input type="hidden" name="variant_id" id="mobileFormVariantId" value="">
            <input type="hidden" name="quantity" id="mobileFormQuantity" value="1">
            <button type="submit" class="btn-cart" onclick="updateFormDataBeforeSubmit(event, 'mobileAddForm')">Add to Cart</button>
        </form>

        <form method="POST" action="{% url 'cart:add_to_cart' %}" id="mobileBuyForm" class="d-inline-block">
            {% csrf_token %}
            <input type="hidden" name="product_id" value="{{ product.id }}">
            <input type="hidden" name="variant_id" id="mobileBuyVariantId" value="">
            <input type="hidden" name="quantity" id="mobileBuyQuantity" value="1">
            <input type="hidden" name="buy_now" value="1">
            <button type="submit" class="btn-buy" onclick="updateFormDataBeforeSubmit(event, 'mobileBuyForm')">Buy Now</button>
        </form>
    </div>
</div>

<script>
// Product data
const productId = {{ product.id }};
const productName = "{{ product.name|escapejs }}";
let basePrice = {{ product.current_price|floatformat:0 }};
let totalPrice = basePrice;
let selectedAddons = [];
let quantity = 1;
let selectedVariantId = null;
let deliveryCharge = 0;

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function changeImage(url, thumb) {
    document.getElementById('mainImage').src = url;
    document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
    if(thumb) thumb.classList.add('active');
}

function selectVariant(btn, price) {
    document.querySelectorAll('.variant-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    basePrice = price;
    selectedVariantId = btn.dataset.variantId;
    updatePrice();
    // update hidden form fields
    const formVariant = document.getElementById('formVariantId');
    const buyVariant = document.getElementById('buyVariantId');
    if(formVariant) formVariant.value = selectedVariantId || '';
    if(buyVariant) buyVariant.value = selectedVariantId || '';
    // mobile forms
    const mFormVar = document.getElementById('mobileFormVariantId');
    const mBuyVar = document.getElementById('mobileBuyVariantId');
    if(mFormVar) mFormVar.value = selectedVariantId || '';
    if(mBuyVar) mBuyVar.value = selectedVariantId || '';
}

function selectSlot(card, charge) {
    document.querySelectorAll('.slot-card').forEach(c => c.classList.remove('active'));
    card.classList.add('active');
    deliveryCharge = charge;
    updatePrice();
}

function toggleAddon(card) {
    const addonId = card.dataset.addonId;
    const addonName = card.dataset.addonName;
    const addonPrice = parseFloat(card.dataset.addonPrice);
    
    console.log('Toggling addon:', addonName, 'ID:', addonId, 'Price:', addonPrice);
    
    if(card.classList.contains('selected')) {
        card.classList.remove('selected');
        selectedAddons = selectedAddons.filter(a => a.id !== addonId);
        console.log('Removed addon:', addonName);
    } else {
        card.classList.add('selected');
        selectedAddons.push({
            id: addonId,
            name: addonName,
            price: addonPrice
        });
        console.log('Added addon:', addonName);
    }
    console.log('Currently selected addons:', selectedAddons);
    updatePrice();
}

function updateQty(change) {
    quantity = Math.max(1, Math.min(10, quantity + change));
    document.getElementById('qty').value = quantity;
    updatePrice();
    // update hidden form quantity fields
    const q = document.getElementById('formQuantity');
    const bq = document.getElementById('buyQuantity');
    if(q) q.value = quantity;
    if(bq) bq.value = quantity;
    // mobile quantity fields
    const mq = document.getElementById('mobileFormQuantity');
    const mbq = document.getElementById('mobileBuyQuantity');
    if(mq) mq.value = quantity;
    if(mbq) mbq.value = quantity;
}

function updatePrice() {
    let addonTotal = selectedAddons.reduce((sum, addon) => sum + addon.price, 0);
    totalPrice = (basePrice + addonTotal) * quantity + deliveryCharge;
    document.getElementById('price').textContent = totalPrice;
    document.getElementById('mobilePrice').textContent = totalPrice;
}

function switchTab(btn, tabId) {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
}

function toggleWishlist() {
    const icon = document.getElementById('wishlistIcon');
    {% if user.is_authenticated %}
        // Make AJAX call to toggle wishlist
        showToast('Wishlist feature coming soon!');
    {% else %}
        showToast('Please login to add to wishlist');
        setTimeout(() => {
            window.location.href = '{% url "users:login" %}?next={{ request.path }}';
        }, 1000);
    {% endif %}
}

function shareProduct() {
    if(navigator.share) {
        navigator.share({
            title: '{{ product.name|escapejs }}',
            text: 'Check out this amazing product!',
            url: window.location.href
        });
    } else {
        navigator.clipboard.writeText(window.location.href);
        showToast('Link copied to clipboard!');
    }
}

function checkPincode() {
    const pincode = document.getElementById('pincode').value;
    const messageDiv = document.getElementById('pincode-message');
    
    if(pincode.length !== 6) {
        messageDiv.innerHTML = '<p style="color:red;">Please enter valid 6-digit pincode</p>';
        return;
    }
    
    // Simulate pincode check
    const validPrefixes = ['110', '120', '400', '500', '560', '600'];
    const isValid = validPrefixes.some(prefix => pincode.startsWith(prefix));
    
    if(isValid) {
        messageDiv.innerHTML = '<p style="color:green;">‚úì Delivery available for ' + pincode + '</p>';
    } else {
        messageDiv.innerHTML = '<p style="color:red;">‚úó Delivery not available for ' + pincode + '</p>';
    }
}

// Update form data before submission (called by button onclick)
function updateFormDataBeforeSubmit(event, formId) {
    console.log('updateFormDataBeforeSubmit called for form:', formId);
    console.log('Current quantity:', quantity);
    console.log('Selected variant:', selectedVariantId);
    console.log('Selected addons:', selectedAddons);
    
    // Check if user is authenticated
    {% if not user.is_authenticated %}
        event.preventDefault();
        showToast('Please login to add items to cart');
        setTimeout(() => {
            window.location.href = '{% url "users:login" %}?next={{ request.path }}';
        }, 1000);
        return false;
    {% endif %}
    
    try {
        const form = document.getElementById(formId);
        if (!form) {
            console.error('Form not found:', formId);
            return true; // Allow submission anyway
        }
        
        // Get form-specific elements
        const quantityInput = form.querySelector('input[name="quantity"]');
        const variantInput = form.querySelector('input[name="variant_id"]');
        
        // Update quantity
        if (quantityInput) {
            quantityInput.value = quantity;
            console.log('Updated quantity to:', quantity);
        }
        
        // Update variant
        if (variantInput) {
            variantInput.value = selectedVariantId || '';
            console.log('Updated variant to:', selectedVariantId);
        }
        
        // Clear existing addon inputs in this form
        const existingAddons = form.querySelectorAll('input[name="addon_ids[]"]');
        existingAddons.forEach(input => input.remove());
        
        // Add new addon inputs to this form
        console.log('Number of selected addons:', selectedAddons.length);
        selectedAddons.forEach(addon => {
            const addonInput = document.createElement('input');
            addonInput.type = 'hidden';
            addonInput.name = 'addon_ids[]';
            addonInput.value = addon.id;
            form.appendChild(addonInput);
            console.log('Added addon to form:', addon.name, 'with ID:', addon.id);
        });
        
        // Log all form data for debugging
        const formData = new FormData(form);
        console.log('=== FORM DATA BEFORE SUBMISSION ===');
        for (let pair of formData.entries()) {
            console.log(pair[0] + ': ' + pair[1]);
        }
        console.log('===================================');
        
        console.log('Form data updated successfully for', formId);
        // Don't prevent default, let form submit normally
        return true;
    } catch (error) {
        console.error('Error in updateFormDataBeforeSubmit:', error);
        // Still allow form submission even if there's an error
        return true;
    }
}

function buyNow() {
    {% if user.is_authenticated %}
        // First add to cart
        addToCart();
        // Then redirect to cart after a delay
        setTimeout(() => {
            window.location.href = '{% url "cart:cart" %}';
        }, 1500);
    {% else %}
        showToast('Please login to continue');
        setTimeout(() => {
            window.location.href = '{% url "users:login" %}?next={{ request.path }}';
        }, 1000);
    {% endif %}
}

function showToast(message) {
    // Remove any existing toast
    const existingToast = document.querySelector('.toast-msg');
    if(existingToast) existingToast.remove();
    
    const toast = document.createElement('div');
    toast.className = 'toast-msg';
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 12px 24px;
        border-radius: 24px;
        z-index: 10000;
        animation: slideUp 0.3s ease;
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}
</script>
{% endblock %}