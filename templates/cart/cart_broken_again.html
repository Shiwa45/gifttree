{% extends 'base.html' %}
{% load static %}

{% block title %}Shopping Cart - Review Your Order | GiftTree{% endblock %}

{% block meta_description %}Review your shopping cart and proceed to checkout. Fresh flowers, cakes and gifts with same
day delivery available.{% endblock %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
{% csrf_token %}

<!-- Mobile Header with Back Button -->
{% include 'includes/mobile_header.html' with show_back_button=True page_title="Shopping Cart" %}

<!-- Empty Cart State -->
<div class="empty-cart" id="emptyCart" {% if cart_items %}style="display: none;" {% endif %}>
    <div class="empty-icon">
        <i class="fas fa-shopping-cart"></i>
    </div>
    <h2 class="empty-title">Your cart is empty</h2>
    <p class="empty-subtitle">Add some beautiful flowers and gifts to brighten someone's day!</p>
    <a href="{% url 'products:product_list' %}" class="shop-now-btn">Start Shopping</a>
</div>

<!-- Cart Content -->
<div id="cartContent" {% if not cart_items %}style="display: none;" {% endif %}>
    <!-- Cart Items Section -->
    <div class="cart-section">
        <div class="cart-header">
            <h2 class="section-title">Your Items</h2>
            <button class="header-checkout-btn" onclick="proceedToCheckout()" {% if not cart_items %}disabled{% endif
                %}>
                <i class="fas fa-credit-card"></i>
                Checkout Now
            </button>
        </div>
        <div class="cart-items" id="cartItems">
            {% for item in cart_items %}
            <div class="cart-item" data-item-id="{{ item.id }}">
                <img src="{% if item.product.primary_image %}{{ item.product.primary_image.get_image_url }}{% else %}{% static 'images/products/default.jpg' %}{% endif %}"
                    alt="{{ item.product.name }}" class="item-image">
                <div class="item-details">
                    <div class="item-name">{{ item.product.name }}</div>
                    {% if item.addons %}
                    <div class="item-addons">+ {{ item.addons|join:", " }}</div>
                    {% endif %}
                    <div class="item-price-section">
                        <div class="item-price">₹{{ item.total_price }}</div>
                        <div class="quantity-controls">
                            <button class="qty-btn" onclick="updateQuantity('{{ item.id }}', -1)" {% if item.quantity
                                <=1 %}disabled{% endif %}>
                                <i class="fas fa-minus"></i>
                            </button>
                            <div class="qty-display">{{ item.quantity }}</div>
                            <button class="qty-btn" onclick="updateQuantity('{{ item.id }}', 1)" {% if item.quantity>=
                                10 %}disabled{% endif %}>
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <button class="remove-item" onclick="removeItem('{{ item.id }}')" title="Remove item">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            {% empty %}
            <div class="empty-cart-message">
                <p>Your cart is empty</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Delivery Options -->
    <div class="delivery-section">
        <h3 class="delivery-title">Delivery Options</h3>
        <div class="delivery-options">
            <div class="delivery-option selected" onclick="selectDelivery(this, 0)">
                <input type="radio" name="delivery" class="delivery-radio" checked>
                <div class="delivery-icon">
                    <i class="fas fa-shipping-fast"></i>
                </div>
                <div class="delivery-details">
                    <div class="delivery-name">Same Day Delivery</div>
                    <div class="delivery-time">Within 3-6 hours</div>
                </div>
                <div class="delivery-price free-delivery">FREE</div>
            </div>
            <div class="delivery-option" onclick="selectDelivery(this, 99)">
                <input type="radio" name="delivery" class="delivery-radio">
                <div class="delivery-icon">
                    <i class="fas fa-moon"></i>
                </div>
                <div class="delivery-details">
                    <div class="delivery-name">Midnight Delivery</div>
                    <div class="delivery-time">12:00 AM - 12:30 AM</div>
                </div>
                <div class="delivery-price">₹99</div>
            </div>
            <div class="delivery-option" onclick="selectDelivery(this, 49)">
                <input type="radio" name="delivery" class="delivery-radio">
                <div class="delivery-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="delivery-details">
                    <div class="delivery-name">Fixed Time Delivery</div>
                    <div class="delivery-time">Choose your preferred slot</div>
                </div>
                <div class="delivery-price">₹49</div>
            </div>
        </div>

        <!-- Continue Button for Delivery Options -->
        <div class="section-continue">
            <button type="button" class="btn-continue-delivery" onclick="continueToPaymentOptions()">
                Continue to Payment Options
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Coupon Section -->
    <div class="coupon-section">
        <h3 class="coupon-title">Apply Coupon</h3>
        <div class="coupon-input-group">
            <input type="text" class="coupon-input" placeholder="Enter coupon code" id="couponInput">
            <button class="apply-coupon-btn" onclick="applyCoupon()">APPLY</button>
        </div>
        <div class="available-coupons">
            <div class="coupon-chip" onclick="applyCouponCode('SAVE10')">SAVE10</div>
            <div class="coupon-chip" onclick="applyCouponCode('FLOWER20')">FLOWER20</div>
            <div class="coupon-chip" onclick="applyCouponCode('FIRST15')">FIRST15</div>
        </div>
        <div id="appliedCoupon" style="display: none; margin-top: 12px;">
            <!-- Applied coupon will appear here -->
        </div>
    </div>

    <!-- Payment Options Section -->
    <div class="payment-section" id="paymentSection" style="display: none;">
        <h3 class="payment-title">Payment Method</h3>
        <div class="payment-options">
            <div class="payment-option selected" onclick="selectPaymentMethod(this, 'online')">
                <input type="radio" name="payment_method" value="online" checked>
                <div class="payment-icon">
                    <i class="fas fa-credit-card"></i>
                </div>
                <div class="payment-details">
                    <div class="payment-name">Online Payment</div>
                    <div class="payment-desc">Credit/Debit Card, UPI, Net Banking, Wallets</div>
                </div>
                <div class="payment-badge">
                    <i class="fas fa-shield-alt"></i> Secure
                </div>
            </div>

            <div class="payment-option" onclick="selectPaymentMethod(this, 'cod')">
                <input type="radio" name="payment_method" value="cod">
                <div class="payment-icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="payment-details">
                    <div class="payment-name">Cash on Delivery</div>
                    <div class="payment-desc">Pay when you receive</div>
                </div>
                <div class="payment-badge cod">
                    Available
                </div>
            </div>
        </div>

        <!-- Payment Security Info -->
        <div class="payment-security">
            <i class="fas fa-lock"></i>
            <span>Your payment information is secure and encrypted</span>
        </div>

        <!-- Continue Button for Payment -->
        <div class="section-continue">
            <button type="button" class="btn-continue-payment" onclick="continueToOrderReview()">
                Review Order & Place Order
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
    </div>

    <!-- Order Summary -->
    <div class="order-summary">
        <h3 class="summary-title">Order Summary</h3>

        <!-- Quick Checkout Button (Always Visible) -->
        <div class="quick-checkout-section">
            <button class="quick-checkout-btn" onclick="proceedToCheckout()" {% if not cart_items %}disabled{% endif %}>
                <i class="fas fa-shopping-bag"></i>
                Quick Checkout - ₹{{ cart_total }}
            </button>
            <p class="quick-checkout-note">Or follow the steps below for delivery & payment options</p>
        </div>
        <div class="summary-row">
            <span class="summary-label">Subtotal (<span id="itemCount">{{ cart_items.count }}</span> items)</span>
            <span class="summary-value">₹<span id="subtotal">{{ cart_subtotal }}</span></span>
        </div>
        <div class="summary-row">
            <span class="summary-label">Delivery Charges</span>
            <span class="summary-value" id="deliveryCharges">FREE</span>
        </div>
        <div class="summary-row" id="couponDiscountRow" style="display: none;">
            <span class="summary-label">Coupon Discount</span>
            <span class="summary-value" style="color: var(--secondary-color);">-₹<span
                    id="couponDiscount">0</span></span>
        </div>
        <div class="summary-divider"></div>
        <div class="summary-total">
            <span>Total Amount</span>
            <span>₹<span id="totalAmount">{{ cart_total }}</span></span>
        </div>
        <div class="savings-highlight" id="savingsText" style="display: none;">
            You saved ₹<span id="totalSavings">0</span> on this order!
        </div>
    </div>

    <!-- Recommendations -->
    <div class="recommendations">
        <h3 class="rec-title">Frequently Bought Together</h3>
        <div class="rec-scroll">
            <div class="rec-row">
                {% for product in recommended_products %}
                <div class="rec-card" onclick="window.location.href='{{ product.get_absolute_url }}'">
                    {% if product.primary_image %}
                    <img src="{{ product.primary_image.get_image_url }}" alt="{{ product.name }}" class="rec-image">
                    {% else %}
                    <img src="{% static 'images/products/default.jpg' %}" alt="{{ product.name }}" class="rec-image">
                    {% endif %}
                    <div class="rec-info">
                        <div class="rec-name">{{ product.name|truncatechars:15 }}</div>
                        <div class="rec-price">₹{{ product.current_price }}</div>
                        <button class="add-rec-btn"
                            onclick="event.stopPropagation(); addRecommendation('{{ product.name|escapejs }}', {{ product.current_price }})">ADD</button>
                    </div>
                </div>
                {% empty %}
                <!-- Default recommendations -->
                <div class="rec-card">
                    <img src="{% static 'images/products/chocko cake.jpg' %}" alt="Chocolate Cake" class="rec-image">
                    <div class="rec-info">
                        <div class="rec-name">Chocolate Cake</div>
                        <div class="rec-price">₹299</div>
                        <button class="add-rec-btn" onclick="addRecommendation('Chocolate Cake', 299)">ADD</button>
                    </div>
                </div>
                <div class="rec-card">
                    <img src="{% static 'images/products/teddy.webp' %}" alt="Teddy Bear" class="rec-image">
                    <div class="rec-info">
                        <div class="rec-name">Teddy Bear</div>
                        <div class="rec-price">₹199</div>
                        <button class="add-rec-btn" onclick="addRecommendation('Teddy Bear', 199)">ADD</button>
                    </div>
                </div>
                <div class="rec-card">
                    <img src="{% static 'images/products/default.jpg' %}" alt="Greeting Card" class="rec-image">
                    <div class="rec-info">
                        <div class="rec-name">Greeting Card</div>
                        <div class="rec-price">₹149</div>
                        <button class="add-rec-btn" onclick="addRecommendation('Greeting Card', 149)">ADD</button>
                    </div>
                </div>
                <div class="rec-card">
                    <img src="{% static 'images/products/default.jpg' %}" alt="Premium Chocolates" class="rec-image">
                    <div class="rec-info">
                        <div class="rec-name">Premium Chocolates</div>
                        <div class="rec-price">₹399</div>
                        <button class="add-rec-btn" onclick="addRecommendation('Premium Chocolates', 399)">ADD</button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Sticky Bottom -->
<div class="sticky-bottom">
    <div class="bottom-summary">
        <span>Total: ₹<span id="bottomTotal">{{ cart_total }}</span></span>
        <span><span id="bottomItemCount">{{ cart_items.count }}</span> items</span>
    </div>
    <button class="checkout-btn" onclick="proceedToCheckout()" id="checkoutButton" {% if not cart_items %}disabled{%
        endif %}>
        PROCEED TO CHECKOUT
    </button>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast"></div>
{% endblock %}

{% block extra_css %}
<style>
    /* Cart specific styles */
    .empty-cart {
        background: white;
        padding: 40px 20px;
        text-align: center;
        margin: 20px 16px;
        border-radius: 12px;
    }

    .empty-icon {
        font-size: 64px;
        color: #E0E0E0;
        margin-bottom: 20px;
    }

    .empty-title {
        font-size: 24px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 8px;
    }

    .empty-subtitle {
        color: var(--text-light);
        margin-bottom: 24px;
    }

    .shop-now-btn {
        background: var(--pink-gradient);
        color: white;
        border: none;
        border-radius: 25px;
        padding: 12px 32px;
        font-size: 16px;
        font-weight: 600;
        text-decoration: none;
        display: inline-block;
        transition: all 0.3s;
    }

    .shop-now-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(233, 30, 99, 0.3);
        color: white;
    }

    .cart-section {
        margin: 0 16px 20px;
    }

    .cart-header {
        background: white;
        padding: 20px 16px 0;
        border-radius: 12px 12px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 16px;
        margin: 0;
    }

    .header-checkout-btn {
        background: var(--pink-gradient);
        color: white;
        border: none;
        border-radius: 20px;
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .header-checkout-btn:hover:not(:disabled) {
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(233, 30, 99, 0.3);
    }

    .header-checkout-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .cart-items {
        background: white;
        border-radius: 0 0 12px 12px;
        overflow: hidden;
    }

    .cart-item {
        display: flex;
        align-items: center;
        padding: 16px;
        border-bottom: 1px solid #f0f0f0;
        position: relative;
    }

    .cart-item:last-child {
        border-bottom: none;
    }

    .item-image {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        margin-right: 12px;
        flex-shrink: 0;
    }

    .item-details {
        flex: 1;
        min-width: 0;
    }

    .item-name {
        font-size: 16px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 4px;
        line-height: 1.3;
    }

    .item-addons {
        font-size: 12px;
        color: var(--text-light);
        margin-bottom: 8px;
    }

    .item-price-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .item-price {
        font-size: 16px;
        font-weight: 600;
        color: var(--primary-color);
    }

    .quantity-controls {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .qty-btn {
        width: 32px;
        height: 32px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.2s;
    }

    .qty-btn:hover:not(:disabled) {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .qty-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .qty-display {
        min-width: 24px;
        text-align: center;
        font-weight: 600;
    }

    .remove-item {
        position: absolute;
        top: 12px;
        right: 12px;
        width: 32px;
        height: 32px;
        border: none;
        background: #ff4757;
        color: white;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .remove-item:hover {
        background: #ff3742;
        transform: scale(1.1);
    }

    .delivery-section,
    .coupon-section,
    .order-summary,
    .recommendations,
    .payment-section {
        background: white;
        margin: 0 16px 20px;
        padding: 20px 16px;
        border-radius: 12px;
    }

    .delivery-title,
    .coupon-title,
    .summary-title,
    .rec-title,
    .payment-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 16px;
    }

    /* Quick Checkout Section */
    .quick-checkout-section {
        text-align: center;
        margin-bottom: 20px;
        padding: 16px;
        background: linear-gradient(135deg, #E91E63 0%, #FF6090 100%);
        border-radius: 12px;
        color: white;
    }

    .quick-checkout-btn {
        background: white;
        color: var(--primary-color);
        border: none;
        border-radius: 25px;
        padding: 14px 28px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .quick-checkout-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
    }

    .quick-checkout-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .quick-checkout-note {
        font-size: 12px;
        margin: 0;
        opacity: 0.9;
    }

    .delivery-options {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .delivery-option {
        display: flex;
        align-items: center;
        padding: 16px;
        border: 2px solid #f0f0f0;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .delivery-option.selected {
        border-color: var(--primary-color);
        background: rgba(233, 30, 99, 0.05);
    }

    .delivery-radio {
        margin-right: 12px;
    }

    .delivery-icon {
        font-size: 24px;
        color: var(--primary-color);
        margin-right: 12px;
    }

    .delivery-details {
        flex: 1;
    }

    .delivery-name {
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 4px;
    }

    .delivery-time {
        font-size: 14px;
        color: var(--text-light);
    }

    .delivery-price {
        font-weight: 600;
        color: var(--text-dark);
    }

    .free-delivery {
        color: var(--secondary-color);
    }

    /* Continue Buttons */
    .section-continue {
        margin-top: 20px;
        text-align: center;
    }

    .btn-continue-delivery,
    .btn-continue-payment {
        background: var(--pink-gradient);
        color: white;
        border: none;
        border-radius: 25px;
        padding: 12px 32px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-continue-delivery:hover,
    .btn-continue-payment:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(233, 30, 99, 0.3);
    }

    /* Payment Options */
    .payment-options {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 16px;
    }

    .payment-option {
        display: flex;
        align-items: center;
        padding: 16px;
        border: 2px solid #f0f0f0;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .payment-option.selected {
        border-color: var(--primary-color);
        background: rgba(233, 30, 99, 0.05);
    }

    .payment-option input[type="radio"] {
        margin-right: 12px;
    }

    .payment-icon {
        font-size: 24px;
        color: var(--primary-color);
        margin-right: 12px;
        width: 40px;
        text-align: center;
    }

    .payment-details {
        flex: 1;
    }

    .payment-name {
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 4px;
    }

    .payment-desc {
        font-size: 14px;
        color: var(--text-light);
    }

    .payment-badge {
        font-size: 12px;
        font-weight: 600;
        color: var(--secondary-color);
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .payment-badge.cod {
        color: var(--accent-color);
    }

    .payment-security {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        color: var(--text-light);
        margin-bottom: 16px;
        justify-content: center;
    }

    .payment-security i {
        color: var(--secondary-color);
    }

    .coupon-input-group {
        display: flex;
        gap: 8px;
        margin-bottom: 12px;
    }

    .coupon-input {
        flex: 1;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
    }

    .apply-coupon-btn {
        padding: 12px 20px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
    }

    .available-coupons {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .coupon-chip {
        padding: 6px 12px;
        background: #f8f9fa;
        border: 1px solid #ddd;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .coupon-chip:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .summary-label {
        color: var(--text-light);
    }

    .summary-value {
        font-weight: 600;
        color: var(--text-dark);
    }

    .summary-divider {
        height: 1px;
        background: #f0f0f0;
        margin: 16px 0;
    }

    .summary-total {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 18px;
        font-weight: 600;
        color: var(--text-dark);
    }

    .savings-highlight {
        text-align: center;
        color: var(--secondary-color);
        font-weight: 600;
        margin-top: 8px;
    }

    .rec-scroll {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    .rec-row {
        display: flex;
        gap: 12px;
        min-width: max-content;
        padding-bottom: 8px;
    }

    .rec-card {
        width: 120px;
        flex-shrink: 0;
        background: #f8f9fa;
        border-radius: 12px;
        padding: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .rec-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .rec-image {
        width: 100%;
        height: 80px;
        object-fit: cover;
        border-radius: 8px;
        margin-bottom: 8px;
    }

    .rec-info {
        text-align: center;
    }

    .rec-name {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-dark);
        margin-bottom: 4px;
        line-height: 1.2;
    }

    .rec-price {
        font-size: 14px;
        font-weight: 600;
        color: var(--primary-color);
        margin-bottom: 8px;
    }

    .add-rec-btn {
        width: 100%;
        padding: 6px;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
    }

    .sticky-bottom {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        padding: 16px;
        border-top: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
        gap: 16px;
        z-index: 100;
    }

    .bottom-summary {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 2px;
    }

    .bottom-summary span:first-child {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-dark);
    }

    .bottom-summary span:last-child {
        font-size: 14px;
        color: var(--text-light);
    }

    .checkout-btn {
        padding: 12px 24px;
        background: var(--pink-gradient);
        color: white;
        border: none;
        border-radius: 25px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .checkout-btn:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(233, 30, 99, 0.3);
    }

    .checkout-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
    }

    .toast {
        position: fixed;
        bottom: 100px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 14px;
        z-index: 1000;
        opacity: 0;
        transition: all 0.3s;
    }

    .toast.show {
        opacity: 1;
        bottom: 120px;
    }

    /* Pulse animation for checkout button */
    @keyframes pulse {
        0% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(233, 30, 99, 0.7);
        }

        70% {
            transform: scale(1.05);
            box-shadow: 0 0 0 10px rgba(233, 30, 99, 0);
        }

        100% {
            transform: scale(1);
            box-shadow: 0 0 0 0 rgba(233, 30, 99, 0);
        }
    }

    /* Desktop adjustments */
    @media (min-width: 992px) {
        body {
            padding-bottom: 0;
        }

        .cart-section,
        .delivery-section,
        .coupon-section,
        .order-summary,
        .recommendations,
        .payment-section {
            margin: 0 40px 30px;
            padding: 30px;
        }

        .sticky-bottom {
            display: none;
        }

        .cart-item {
            padding: 20px;
        }

        .item-image {
            width: 100px;
            height: 100px;
        }

        .empty-cart {
            margin: 40px;
            padding: 60px 40px;
        }
    }
</style>
{% endblock %}

{% block page_js %}
<script src="{% static 'js/cart.js' %}"></script>
<script>
    // Cart page specific JavaScript
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize cart with Django data
        {% if cart_items %}
        const djangoCartItems = [
            {% for item in cart_items %}
            {
            id: '{{ item.id }}',
            name: '{{ item.product.name|escapejs }}',
            price: {{ item.product.current_price }},
        quantity: {{ item.quantity }},
        addons: [{% for addon in item.addons %}'{{ addon|escapejs }}'{% if not forloop.last %}, {% endif %} {% endfor %}],
    image: '{% if item.product.primary_image %}{{ item.product.primary_image.get_image_url }}{% else %}{% static "images/products/default.jpg" %}{% endif %}',
        total: { { item.total_price } }
            }{% if not forloop.last %}, {% endif %}
    {% endfor %}
        ];

    // Update global cart items
    if (typeof window.cartItems !== 'undefined') {
        window.cartItems = djangoCartItems;
    }
    {% endif %}

    // Update cart display
    updateCartDisplay();
});

    // Step-by-step cart flow functions
    function continueToPaymentOptions() {
        // Show payment section
        const paymentSection = document.getElementById('paymentSection');
        paymentSection.style.display = 'block';

        // Scroll to payment section
        paymentSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

        showToast('Please select your payment method');
    }

    function selectPaymentMethod(element, method) {
        // Remove selected class from all payment options
        document.querySelectorAll('.payment-option').forEach(opt => {
            opt.classList.remove('selected');
            opt.querySelector('input[type="radio"]').checked = false;
        });

        // Add selected class to clicked option
        element.classList.add('selected');
        element.querySelector('input[type="radio"]').checked = true;

        showToast(`${method === 'online' ? 'Online Payment' : 'Cash on Delivery'} selected`);
    }

    function continueToOrderReview() {
        // Check if payment method is selected
        const selectedPayment = document.querySelector('input[name="payment_method"]:checked');
        if (!selectedPayment) {
            showToast('Please select a payment method');
            return;
        }

        // Show order summary prominently
        const orderSummary = document.querySelector('.order-summary');
        orderSummary.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Enable the checkout button
        const checkoutBtn = document.getElementById('checkoutButton');
        checkoutBtn.style.background = 'var(--pink-gradient)';
        checkoutBtn.style.transform = 'scale(1.05)';

        showToast('Ready to place order! Click "PROCEED TO CHECKOUT" below');

        // Highlight the checkout button
        setTimeout(() => {
            checkoutBtn.style.animation = 'pulse 2s infinite';
        }, 1000);
    }

    // Django-specific cart functions
    function updateQuantity(itemId, change) {
        // Get current quantity and calculate new quantity
        const qtyDisplay = document.querySelector(`[data-item-id="${itemId}"] .qty-display`);
        const currentQty = parseInt(qtyDisplay.textContent);
        const newQty = Math.max(1, currentQty + change);

        // Make AJAX request to update quantity
        fetch(`/cart/update/${itemId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                quantity: newQty
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Reload to update cart display
                } else {
                    showToast('Error updating quantity');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error updating quantity');
            });
    }

    function removeItem(itemId) {
        if (confirm('Are you sure you want to remove this item?')) {
            // Make AJAX request to remove item
            fetch(`/cart/remove/${itemId}/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(); // Reload to update cart display
                    } else {
                        showToast('Error removing item');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('Error removing item');
                });
        }
    }

    function proceedToCheckout() {
        const checkoutButton = document.getElementById('checkoutButton');
        if (checkoutButton) {
            checkoutButton.disabled = true;
            checkoutButton.textContent = 'Processing...';
        }

        showToast('Proceeding to checkout...');

        // Redirect to checkout page
        setTimeout(() => {
            window.location.href = '{% url "orders:checkout" %}';
        }, 1000);
    }

    function updateCartDisplay() {
        // Update cart count in header
        const cartCount = {{ cart_items.count }
    };
    const cartBadges = document.querySelectorAll('.cart-badge, .cart-count');
    cartBadges.forEach(badge => {
        badge.textContent = cartCount;
    });

    // Show/hide empty cart state
    if (cartCount === 0) {
        document.getElementById('emptyCart').style.display = 'block';
        document.getElementById('cartContent').style.display = 'none';
    } else {
        document.getElementById('emptyCart').style.display = 'none';
        document.getElementById('cartContent').style.display = 'block';
    }
}

    // Delivery selection function
    function selectDelivery(element, charge) {
        // Remove selected class from all options
        document.querySelectorAll('.delivery-option').forEach(opt => {
            opt.classList.remove('selected');
            opt.querySelector('.delivery-radio').checked = false;
        });

        // Add selected class to clicked option
        element.classList.add('selected');
        element.querySelector('.delivery-radio').checked = true;

        // Update delivery charges
        const deliveryChargesEl = document.getElementById('deliveryCharges');
        const totalAmountEl = document.getElementById('totalAmount');
        const bottomTotalEl = document.getElementById('bottomTotal');

        if (charge === 0) {
            deliveryChargesEl.textContent = 'FREE';
            deliveryChargesEl.style.color = 'var(--secondary-color)';
        } else {
            deliveryChargesEl.textContent = `₹${charge}`;
            deliveryChargesEl.style.color = 'var(--text-dark)';
        }

        // Update total (assuming subtotal is available)
        const subtotal = parseFloat(document.getElementById('subtotal').textContent);
        const newTotal = subtotal + charge;
        totalAmountEl.textContent = newTotal;
        bottomTotalEl.textContent = newTotal;
    }

    // Coupon functions
    function applyCoupon() {
        const couponInput = document.getElementById('couponInput');
        const couponCode = couponInput.value.trim().toUpperCase();

        if (!couponCode) {
            showToast('Please enter a coupon code');
            return;
        }

        // Show loading state
        const applyBtn = document.querySelector('.apply-coupon-btn');
        const originalText = applyBtn.textContent;
        applyBtn.textContent = 'APPLYING...';
        applyBtn.disabled = true;

        // Make AJAX request to apply coupon
        fetch('/orders/apply-coupon/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `coupon_code=${encodeURIComponent(couponCode)}`
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(data.message);
                    // Update UI with discount
                    showCouponDiscount(data.coupon);
                    couponInput.value = '';
                } else {
                    showToast(data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error applying coupon');
            })
            .finally(() => {
                applyBtn.textContent = originalText;
                applyBtn.disabled = false;
            });
    }

    function applyCouponCode(code) {
        document.getElementById('couponInput').value = code;
        applyCoupon();
    }

    function showCouponDiscount(coupon) {
        const discountRow = document.getElementById('couponDiscountRow');
        const discountAmount = document.getElementById('couponDiscount');
        const savingsText = document.getElementById('savingsText');
        const totalSavings = document.getElementById('totalSavings');

        discountAmount.textContent = coupon.discount_amount;
        discountRow.style.display = 'flex';

        totalSavings.textContent = coupon.discount_amount;
        savingsText.style.display = 'block';

        // Update totals
        updateTotalsWithDiscount(coupon.discount_amount);
    }

    function updateTotalsWithDiscount(discountAmount) {
        const subtotal = parseFloat(document.getElementById('subtotal').textContent);
        const deliveryCharges = document.getElementById('deliveryCharges').textContent;
        const deliveryCharge = deliveryCharges === 'FREE' ? 0 : parseFloat(deliveryCharges.replace('₹', ''));

        const newTotal = subtotal + deliveryCharge - discountAmount;

        document.getElementById('totalAmount').textContent = newTotal;
        document.getElementById('bottomTotal').textContent = newTotal;
    }

    // Recommendation functions
    function addRecommendation(productName, price) {
        showToast(`${productName} added to cart!`);

        // Update cart count (simplified)
        const cartBadges = document.querySelectorAll('.cart-badge, .cart-count');
        cartBadges.forEach(badge => {
            const currentCount = parseInt(badge.textContent) || 0;
            badge.textContent = currentCount + 1;
        });

        // Update totals (simplified)
        const currentTotal = parseFloat(document.getElementById('totalAmount').textContent);
        const newTotal = currentTotal + price;
        document.getElementById('totalAmount').textContent = newTotal;
        document.getElementById('bottomTotal').textContent = newTotal;
    }

    // Toast notification function
    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');

        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }
</script>
{% endblock %}